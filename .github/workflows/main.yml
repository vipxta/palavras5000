name: Build Android AppBundle

on:
  workflow_dispatch:

env:
  APP_NAME: palavras5000
  ORG: com.seunome # mude para seu pacote, ex.: com.minhaempresa

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug workspace (opcional)
        run: |
          pwd
          echo "Conteúdo da raiz:"
          ls -la

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Create Flutter project
        run: |
          flutter --version
          flutter create --org $ORG $APP_NAME

      - name: Write pubspec.yaml
        run: |
          cat > $APP_NAME/pubspec.yaml << 'EOF'
          name: palavras5000
          description: Aprenda 5.000 palavras com frases e quiz (2.000 grátis + packs premium).
          publish_to: "none"
          version: 1.0.0+1

          environment:
            sdk: ">=3.3.0 <4.0.0"

          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.8
            flutter_tts: ^3.8.3
            in_app_purchase: ^3.1.7
            shared_preferences: ^2.2.3

          flutter:
            uses-material-design: true
            assets:
              - assets/words.json
          EOF

      - name: Write source files
        run: |
          mkdir -p $APP_NAME/lib $APP_NAME/assets
          cat > $APP_NAME/lib/main.dart << 'EOF'
import 'dart:async';
import 'dart:convert';
import 'dart:math';

import 'package:flutter/material.dart';
import 'package:flutter/services.dart' show rootBundle;
import 'package:flutter_tts/flutter_tts.dart';
import 'package:in_app_purchase/in_app_purchase.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  final app = AppState();
  await app.init();
  runApp(MyApp(app));
}

class Example {
  final String en;
  final String pt;
  Example({required this.en, required this.pt});
  factory Example.fromJson(Map<String, dynamic> j) =>
      Example(en: j['en'] ?? '', pt: j['pt'] ?? '');
}

class Word {
  final int rank;
  final String headword;
  final List<String> translationPt;
  final String cefr;
  final bool free;
  final String packId;
  final List<String> pos;
  final List<Example> examples;

  Word({
    required this.rank,
    required this.headword,
    required this.translationPt,
    required this.cefr,
    required this.free,
    required this.packId,
    required this.pos,
    required this.examples,
  });

  factory Word.fromJson(Map<String, dynamic> j) => Word(
        rank: j['rank'] ?? 0,
        headword: j['headword'] ?? '',
        translationPt:
            (j['translation_pt'] as List?)?.map((e) => '$e').toList() ?? [],
        cefr: j['cefr'] ?? '',
        free: j['free'] ?? false,
        packId: j['pack_id'] ?? '',
        pos: (j['pos'] as List?)?.map((e) => '$e').toList() ?? [],
        examples: (j['examples'] as List?)
                ?.map((e) => Example.fromJson(Map<String, dynamic>.from(e)))
                .toList() ??
            [],
      );
}

class PackInfo {
  final String id;
  final String title;
  final bool free;
  PackInfo({required this.id, required this.title, required this.free});
}

class WordRepository {
  late final List<Word> words;
  late final Map<String, PackInfo> packs;

  Future<void> load() async {
    final s = await rootBundle.loadString('assets/words.json');
    final j = json.decode(s);
    final List packsJson = j['packs'] ?? [];
    packs = {
      for (final p in packsJson)
        p['id']: PackInfo(
          id: p['id'],
          title: p['title'] ?? p['id'],
          free: p['free'] == true,
        )
    };
    final List wordsJson = j['words'] ?? [];
    words = wordsJson.map((e) => Word.fromJson(e)).toList()
      ..sort((a, b) => a.rank.compareTo(b.rank));
  }

  List<Word> wordsByPack(String packId) =>
      words.where((w) => w.packId == packId).toList();

  List<Word> search(String query, {String? packId}) {
    if (query.trim().isEmpty) {
      return packId == null ? words : wordsByPack(packId);
    }
    final q = query.toLowerCase();
    return (packId == null ? words : wordsByPack(packId)).where((w) {
      final inHead = w.headword.toLowerCase().contains(q);
      final inTr = w.translationPt.any((t) => t.toLowerCase().contains(q));
      return inHead || inTr;
    }).toList();
  }
}

class AppState extends ChangeNotifier {
  final repo = WordRepository();
  late final TtsService tts;
  late final IapService iap;
  final Set<String> purchasedPacks = {};
  bool loaded = false;

  Future<void> init() async {
    await repo.load();
    tts = TtsService();
    await _loadPurchases();
    iap = IapService(
      onPurchase: _unlockPackForProduct,
      productIds: const {
        'unlock_2001_3000',
        'unlock_3001_4000',
        'unlock_4001_5000',
      },
    );
    await iap.init();
    loaded = true;
    notifyListeners();
  }

  bool isPackUnlocked(String packId) =>
      repo.packs[packId]?.free == true || purchasedPacks.contains(packId);

  Future<void> _loadPurchases() async {
    final sp = await SharedPreferences.getInstance();
    final list = sp.getStringList('purchased_packs') ?? [];
    purchasedPacks
      ..clear()
      ..addAll(list);
  }

  Future<void> _savePurchases() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setStringList('purchased_packs', purchasedPacks.toList());
  }

  String? _packForProduct(String productId) {
    const map = {
      'unlock_2001_3000': '2001-3000',
      'unlock_3001_4000': '3001-4000',
      'unlock_4001_5000': '4001-5000',
    };
    return map[productId];
  }

  Future<void> _unlockPackForProduct(String productId) async {
    final pack = _packForProduct(productId);
    if (pack != null) {
      purchasedPacks.add(pack);
      await _savePurchases();
      notifyListeners();
    }
  }
}

class TtsService {
  final FlutterTts _tts = FlutterTts();
  TtsService() {
    _tts.setLanguage('en-US');
    _tts.setSpeechRate(0.45);
    _tts.setPitch(1.0);
  }
  Future<void> speak(String text) async {
    await _tts.stop();
    await _tts.speak(text);
  }
  Future<void> stop() => _tts.stop();
}

class IapService {
  final InAppPurchase _iap = InAppPurchase.instance;
  final void Function(String productId) onPurchase;
  final Set<String> productIds;
  late StreamSubscription<List<PurchaseDetails>> _sub;
  bool available = false;
  Map<String, ProductDetails> products = {};

  IapService({required this.onPurchase, required this.productIds});

  Future<void> init() async {
    available = await _iap.isAvailable();
    if (!available) return;
    final resp = await _iap.queryProductDetails(productIds);
    products = {for (final p in resp.productDetails) p.id: p};
    _sub = _iap.purchaseStream.listen(_onPurchaseUpdate, onDone: () {
      _sub.cancel();
    }, onError: (e) {});
  }

  Future<void> dispose() async {
    await _sub.cancel();
  }

  void _onPurchaseUpdate(List<PurchaseDetails> detailsList) async {
    for (final pd in detailsList) {
      if (pd.status == PurchaseStatus.purchased ||
          pd.status == PurchaseStatus.restored) {
        onPurchase(pd.productID);
        if (pd.pendingCompletePurchase) {
          await _iap.completePurchase(pd);
        }
      }
    }
  }

  Future<void> buy(String productId) async {
    if (!products.containsKey(productId)) return;
    final purchaseParam =
        PurchaseParam(productDetails: products[productId]!);
    await _iap.buyNonConsumable(purchaseParam: purchaseParam);
  }

  Future<void> restore() async {
    await _iap.restorePurchases();
  }

  String priceFor(String productId, {String fallback = 'R\$ 6,90'}) {
    final p = products[productId];
    return p?.price ?? fallback;
  }
}

class MyApp extends StatelessWidget {
  final AppState app;
  const MyApp(this.app, {super.key});
  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: app,
      builder: (context, _) {
        return MaterialApp(
          title: '5000 Palavras – Inglês',
          theme: ThemeData(colorSchemeSeed: Colors.indigo, useMaterial3: true),
          home: app.loaded
              ? HomePage(app: app)
              : const Scaffold(
                  body: Center(child: CircularProgressIndicator()),
                ),
        );
      },
    );
  }
}

class HomePage extends StatefulWidget {
  final AppState app;
  const HomePage({super.key, required this.app});
  @override
  State<HomePage> createState() => _HomePageState();
}
class _HomePageState extends State<HomePage> {
  String query = '';
  @override
  Widget build(BuildContext context) {
    final app = widget.app;
    final packs = app.repo.packs.values.toList()
      ..sort((a, b) => a.id.compareTo(b.id));
    final allFree = app.repo.words.where((w) => w.free).toList();
    return Scaffold(
      appBar: AppBar(
        title: const Text('5000 Palavras – Inglês'),
        actions: [
          IconButton(
            onPressed: app.iap.available ? app.iap.restore : null,
            icon: const Icon(Icons.restore),
            tooltip: 'Restaurar compras',
          ),
        ],
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.fromLTRB(12, 12, 12, 4),
            child: TextField(
              decoration: const InputDecoration(
                hintText: 'Buscar palavra ou tradução...',
                prefixIcon: Icon(Icons.search),
                border: OutlineInputBorder(),
              ),
              onChanged: (v) => setState(() => query = v),
            ),
          ),
          Expanded(
            child: ListView(
              children: [
                const Padding(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                  child: Text('Pacotes',
                      style:
                          TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                ),
                ...packs.map((p) => _PackTile(app: app, pack: p)).toList(),
                const Padding(
                  padding: EdgeInsets.fromLTRB(12, 16, 12, 8),
                  child: Text('Explorar (grátis)',
                      style:
                          TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                ),
                ...app.repo
                    .search(query, packId: '1-2000')
                    .take(20)
                    .map((w) => ListTile(
                          title: Text(w.headword),
                          subtitle: Text(w.translationPt.join(', ')),
                          onTap: () => Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (_) => WordDetailPage(app: app, word: w),
                            ),
                          ),
                        ))
                    .toList(),
                if (allFree.isEmpty)
                  const Padding(
                    padding: EdgeInsets.all(16),
                    child: Text(
                      'Nenhuma palavra encontrada.',
                      textAlign: TextAlign.center,
                    ),
                  ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _PackTile extends StatelessWidget {
  final AppState app;
  final PackInfo pack;
  const _PackTile({required this.app, required this.pack});
  @override
  Widget build(BuildContext context) {
    final unlocked = app.isPackUnlocked(pack.id);
    final words = app.repo.wordsByPack(pack.id);
    final total = words.length;
    final title = pack.title;
    final productId = switch (pack.id) {
      '2001-3000' => 'unlock_2001_3000',
      '3001-4000' => 'unlock_3001_4000',
      '4001-5000' => 'unlock_4001_5000',
      _ => '',
    };
    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      child: ListTile(
        leading: Icon(
          unlocked ? Icons.lock_open : (pack.free ? Icons.star : Icons.lock),
          color: unlocked || pack.free ? Colors.green : Colors.grey[700],
        ),
        title: Text(title),
        subtitle: Text('$total palavras'),
        trailing: unlocked || pack.free
            ? ElevatedButton(
                onPressed: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => PackPage(app: app, pack: pack),
                    ),
                  );
                },
                child: const Text('Entrar'),
              )
            : ElevatedButton(
                onPressed: () {
                  showModalBottomSheet(
                    context: context,
                    showDragHandle: true,
                    builder: (_) => _Paywall(
                      app: app,
                      pack: pack,
                      productId: productId,
                    ),
                  );
                },
                child: Text(app.iap.priceFor(productId)),
              ),
      ),
    );
  }
}

class _Paywall extends StatelessWidget {
  final AppState app;
  final PackInfo pack;
  final String productId;
  const _Paywall({required this.app, required this.pack, required this.productId});
  @override
  Widget build(BuildContext context) {
    final price = app.iap.priceFor(productId);
    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 8, 16, 24),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(pack.title,
              style:
                  const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 8),
          const Text(
            'Desbloqueie todas as palavras deste pacote, com frases e quiz completo.',
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          ElevatedButton.icon(
            onPressed: () async {
              Navigator.pop(context);
              await app.iap.buy(productId);
            },
            icon: const Icon(Icons.lock_open),
            label: Text('Desbloquear por $price'),
          ),
          const SizedBox(height: 8),
          TextButton(
            onPressed: app.iap.restore,
            child: const Text('Já comprei? Restaurar compras'),
          )
        ],
      ),
    );
  }
}

class PackPage extends StatefulWidget {
  final AppState app;
  final PackInfo pack;
  const PackPage({super.key, required this.app, required this.pack});
  @override
  State<PackPage> createState() => _PackPageState();
}

class _PackPageState extends State<PackPage> {
  String query = '';
  @override
  Widget build(BuildContext context) {
    final app = widget.app;
    final pack = widget.pack;
    final unlocked = app.isPackUnlocked(pack.id);
    final words = app.repo.search(query, packId: pack.id);
    return Scaffold(
      appBar: AppBar(
        title: Text(pack.title),
        actions: [
          if (unlocked || pack.free)
            IconButton(
              onPressed: words.isEmpty
                  ? null
                  : () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (_) => QuizPage(
                            app: app,
                            words: app.repo.wordsByPack(pack.id),
                          ),
                        ),
                      );
                    },
              icon: const Icon(Icons.quiz),
              tooltip: 'Praticar (quiz)',
            ),
        ],
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.fromLTRB(12, 12, 12, 4),
            child: TextField(
              decoration: const InputDecoration(
                hintText: 'Buscar nesta lista...',
                prefixIcon: Icon(Icons.search),
                border: OutlineInputBorder(),
              ),
              onChanged: (v) => setState(() => query = v),
            ),
          ),
          if (!unlocked && !pack.free)
            Padding(
              padding: const EdgeInsets.all(12),
              child: Row(
                children: [
                  const Icon(Icons.lock, size: 20),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'Prévia: veja exemplos, mas para praticar e ver tudo, desbloqueie o pacote.',
                      style: TextStyle(color: Colors.grey[700]),
                    ),
                  )
                ],
              ),
            ),
          Expanded(
            child: ListView.builder(
              itemCount: words.length,
              itemBuilder: (_, i) {
                final w = words[i];
                final locked = !(pack.free || unlocked);
                return ListTile(
                  title: Text(w.headword),
                  subtitle: Text(w.translationPt.join(', ')),
                  trailing: locked ? const Icon(Icons.lock) : null,
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (_) => WordDetailPage(app: app, word: w),
                      ),
                    );
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

class WordDetailPage extends StatelessWidget {
  final AppState app;
  final Word word;
  const WordDetailPage({super.key, required this.app, required this.word});
  @override
  Widget build(BuildContext context) {
    final pack = app.repo.packs[word.packId]!;
    final unlocked = app.isPackUnlocked(pack.id);
    return Scaffold(
      appBar: AppBar(title: Text(word.headword)),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Wrap(
              crossAxisAlignment: WrapCrossAlignment.center,
              spacing: 8,
              children: [
                Text(
                  word.headword,
                  style: const TextStyle(
                      fontSize: 26, fontWeight: FontWeight.bold),
                ),
                IconButton(
                  onPressed: () => app.tts.speak(word.headword),
                  icon: const Icon(Icons.volume_up),
                ),
              ],
            ),
            Text('Traduções: ${word.translationPt.join(', ')}'),
            const SizedBox(height: 8),
            Text('Nível: ${word.cefr}   Classe: ${word.pos.join(', ')}'),
            const SizedBox
